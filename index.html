<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SouF√°cil Quiz ‚Äì Online</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0b1023;--card:#0f172a;--muted:#94a3b8;--brand:#38bdf8;--ok:#22c55e;--bad:#ef4444}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:radial-gradient(1200px 600px at 20% -10%,#0c1b3a,transparent),linear-gradient(180deg,#0b1023,#0b1023);color:#e5e7eb}
    .container{max-width:1100px;margin:0 auto;padding:20px}
    .card{background:#0f172a;border:1px solid rgba(148,163,184,.15);border-radius:18px;box-shadow:0 10px 40px rgba(0,0,0,.35);padding:18px}
    h1{font-size:28px;margin:0 0 8px;display:flex;align-items:center;gap:10px}
    h2{font-size:20px;margin:12px 0}
    .muted{color:var(--muted)}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#0b2137;border:1px solid rgba(148,163,184,.15);color:#a5b4fc;font-weight:800;font-size:12px}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .col{flex:1 1 320px}
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns:repeat(2,1fr)}
    input,select,button,textarea{font:inherit}
    input,select,textarea{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(148,163,184,.25);background:#0a1222;color:#e5e7eb}
    textarea{min-height:120px}
    .btn{border:0;background:var(--brand);color:#001018;padding:12px 16px;border-radius:12px;cursor:pointer;font-weight:800}
    .btn.secondary{background:#1f2937;color:#e5e7eb;border:1px solid rgba(148,163,184,.2)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .option{padding:14px;border-radius:14px;border:1px solid rgba(148,163,184,.25);background:#0b1529;cursor:pointer}
    .option.correct{outline:2px solid var(--ok)}.option.wrong{outline:2px solid var(--bad)}
    .timer{height:12px;background:#1f2937;border-radius:999px;overflow:hidden}
    .timer>div{height:100%;background:linear-gradient(90deg,#22d3ee,#60a5fa);width:0%}
    .leader{display:grid;grid-template-columns:40px 1fr 120px;gap:8px;align-items:center;padding:10px;border-radius:12px;border:1px solid rgba(148,163,184,.2);background:#0b1426}
    .separator{height:1px;background:rgba(148,163,184,.15);margin:12px 0}
    .hidden{display:none}
    .center{display:flex;align-items:center;justify-content:center}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>‚ö° SouF√°cil Quiz <span class="pill">online (Firebase)</span></h1>
      <div class="muted">Abra este arquivo e compartilhe o c√≥digo da sala para os jogadores entrarem do celular.</div>
      <div class="separator"></div>

      <div class="row">
        <div class="col">
          <h2>üé§ Modo Apresentador (Host)</h2>
          <div class="grid cols-2">
            <div>
              <label class="muted">C√≥digo da sala</label>
              <input id="roomCode" placeholder="ex.: SF1234" />
            </div>
            <div>
              <label class="muted">Seu nome</label>
              <input id="hostName" placeholder="ex.: Host" />
            </div>
          </div>
          <div class="grid cols-2" style="margin-top:8px">
            <div>
              <label class="muted">Dura√ß√£o por pergunta (s)</label>
              <input id="qDuration" type="number" min="5" max="120" value="30" />
            </div>
            <div>
              <label class="muted">Pontos base por acerto</label>
              <input id="baseScore" type="number" min="100" max="5000" value="1000" />
            </div>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="btn" id="btnInitHost">Conectar & Criar sala</button>
            <button class="btn secondary" id="btnStart" disabled>Iniciar jogo</button>
            <button class="btn secondary" id="btnNext" disabled>Pr√≥xima</button>
            <button class="btn secondary" id="btnEnd" disabled>Encerrar</button>
          </div>
          <div id="hostInfo" class="muted" style="margin-top:8px"></div>
          <div class="separator"></div>
          <div id="liveQuestion"></div>
          <div id="liveStats" class="muted"></div>
          <div id="hostLeaderboard" style="margin-top:12px"></div>
        </div>
        <div class="col">
          <h2>üßë‚Äçü§ù‚Äçüßë Modo Jogador</h2>
          <div class="grid cols-2">
            <input id="joinRoom" placeholder="C√≥digo da sala" />
            <input id="playerName" placeholder="Seu nome" />
          </div>
          <div class="row" style="margin-top:10px">
            <button class="btn" id="btnInitPlayer">Conectar</button>
            <button class="btn secondary" id="btnJoin" disabled>Entrar</button>
          </div>
          <div class="card" style="margin-top:10px">
            <div id="phaseLobby">Aguardando‚Ä¶</div>
            <div id="phaseQuestion" class="hidden"></div>
            <div id="phaseFeedback" class="hidden"></div>
            <div id="phaseEnd" class="hidden"></div>
          </div>
        </div>
      </div>

      <div class="separator"></div>
      <div class="muted">Pontua√ß√£o: acerto = base + b√¥nus proporcional ao tempo restante.</div>
    </div>
  </div>

  <!-- Firebase compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>
  <script>
    // üîë Config do seu Firebase (j√° preenchido)
    const firebaseConfig = {
      apiKey: "AIzaSyAns0NBLW8JTmLFRuOSLz16tAXrKuox9rU",
      authDomain: "comercial-92085.firebaseapp.com",
      projectId: "comercial-92085",
      storageBucket: "comercial-92085.firebasestorage.app",
      messagingSenderId: "1086266528954",
      appId: "1:1086266528954:web:91dfc7975e79c5cc141e83"
    };

    // üì¶ Perguntas embutidas (80)
    // Formato: {question, options:[A,B,C,D], correctIndex}
    const BUILTIN_QUESTIONS = [
      // 1‚Äì30 (Simulado Vendedor Externo)
      {question:"Qual √© a postura correta ao chegar em uma loja para a primeira abordagem?", options:["Mexer no celular para parecer ocupado","Chegar sorrindo e mantendo contato visual","Ficar em sil√™ncio at√© o lojista falar primeiro","Sentar-se sem pedir permiss√£o"], correctIndex:1},
      {question:"O que √© essencial para passar uma boa primeira impress√£o?", options:["Falar r√°pido para encurtar a conversa","Ter uniforme limpo e bem passado","Usar acess√≥rios chamativos","For√ßar uma venda imediata"], correctIndex:1},
      {question:"Qual deve ser o tom de voz usado na abordagem?", options:["Alto e autorit√°rio","Claro, aud√≠vel e modulado","Baixo e quase inaud√≠vel","R√°pido e apressado"], correctIndex:1},
      {question:"O que significa escuta ativa?", options:["Interromper o cliente para corrigir","Repetir g√≠rias para criar proximidade","Prestar aten√ß√£o, confirmar e resumir o que o cliente disse","Deixar o cliente falar sem responder"], correctIndex:2},
      {question:"Antes da visita, o que N√ÉO faz parte do planejamento?", options:["Pesquisar sobre o lojista","Preparar material de apoio","Planejar rota","Improvisar totalmente na hora"], correctIndex:3},
      {question:"Durante a visita, qual √© a melhor forma de iniciar a conversa?", options:["Com um quebra-gelo ou elogio sincero","Perguntando direto sobre vendas","Entregando contrato de imediato","Falando mal de concorrentes"], correctIndex:0},
      {question:"Se o lojista disser ‚Äòj√° trabalho com outra financeira‚Äô, a melhor resposta √©:", options:["Ent√£o n√£o preciso explicar","Nossos clientes tamb√©m usavam outras, mas migraram pelos nossos diferenciais","A concorr√™ncia √© ruim, s√≥ n√≥s prestamos","Se mudar de ideia me procure"], correctIndex:1},
      {question:"Qual item √© essencial ap√≥s a visita?", options:["Esquecer o que foi conversado","Enviar mensagem de agradecimento","Evitar contato para n√£o incomodar","Esperar o cliente ligar"], correctIndex:1},
      {question:"Qual deve ser o foco principal da apresenta√ß√£o?", options:["Caracter√≠sticas do produto","Benef√≠cios para o lojista","Falar apenas sobre pre√ßo","Criticar concorrentes"], correctIndex:1},
      {question:"Qual vestimenta √© adequada para homens?", options:["Cal√ßa rasgada, camiseta colorida","Uniforme bem passado e cores neutras","Bon√© e chinelo","Roupas informais e chamativas"], correctIndex:1},
      {question:"Qual vestimenta √© adequada para mulheres?", options:["Roupas curtas e coloridas","Uniforme bem passado, cores neutras e cabelo arrumado","Maquiagem exagerada","Sand√°lia de praia"], correctIndex:1},
      {question:"Se o lojista disser ‚Äòest√° caro‚Äô, qual √© a melhor resposta?", options:["Ent√£o n√£o compre","Entendo, mas veja o retorno que voc√™ ter√°","√â o pre√ßo que temos, n√£o tem o que fazer","Se n√£o quiser, eu saio"], correctIndex:1},
      {question:"O que √© recomendado levar sempre na visita?", options:["Material de vendas completo","Apenas celular","Nada, para n√£o parecer insistente","Apenas cart√£o pessoal"], correctIndex:0},
      {question:"Qual a melhor postura corporal durante a abordagem?", options:["Bra√ßos cruzados","De p√©, postura aberta e receptiva","De costas para o lojista","Sempre sentado"], correctIndex:1},
      {question:"Ap√≥s o lojista dizer ‚Äòpreciso conversar com meu s√≥cio‚Äô, o vendedor deve:", options:["Encerrar a visita imediatamente","Oferecer preparar resumo para o s√≥cio","Dizer que n√£o √© necess√°rio","Pressionar para decidir sozinho"], correctIndex:1},
      {question:"Qual a vantagem de usar perguntas abertas?", options:["Fecham a conversa mais r√°pido","Estimulam o lojista a falar mais","Limitam as respostas a sim/n√£o","Desgastam a paci√™ncia do cliente"], correctIndex:1},
      {question:"O que significa adaptar a linguagem ao perfil do lojista?", options:["Falar dif√≠cil para parecer inteligente","Usar sempre g√≠rias","Ajustar vocabul√°rio de acordo com o cliente","Falar apenas sobre pre√ßo"], correctIndex:2},
      {question:"O que deve ser feito logo ap√≥s sair da loja?", options:["Atualizar lista de visitas e registrar informa√ß√µes","Esquecer para n√£o ocupar mem√≥ria","N√£o anotar nada","Esperar a pr√≥xima semana para lembrar"], correctIndex:0},
      {question:"Se o lojista n√£o estiver interessado, a melhor atitude √©:", options:["For√ßar a venda at√© ele aceitar","Perguntar o que n√£o interessou e anotar feedback","Encerrar sem agradecer","Deixar de lado e nunca mais voltar"], correctIndex:1},
      {question:"Qual √© um diferencial da SouFacil?", options:["Aprova√ß√£o sem burocracia","Vendas apenas √† vista","Taxa fixa e alta para todos","N√£o oferecer parcelamento"], correctIndex:0},
      {question:"O que deve ser feito quando o cliente apresenta uma obje√ß√£o?", options:["Contradizer imediatamente","Ouvir, validar e responder com benef√≠cios","Interromper para n√£o perder tempo","Mudar de assunto"], correctIndex:1},
      {question:"Qual deve ser a postura diante de atrasos?", options:["Chegar sem avisar","Sempre respeitar o hor√°rio combinado","Avisar que n√£o tem tempo","Cancelar sem justificar"], correctIndex:1},
      {question:"Como refor√ßar credibilidade na visita?", options:["Mostrar m√©tricas reais de aumento de vendas","Falar apenas de pre√ßo","Prometer o imposs√≠vel","Evitar responder d√∫vidas"], correctIndex:0},
      {question:"Um bom fechamento de visita inclui:", options:["Estabelecer pr√≥ximos passos concretos","N√£o marcar nada para n√£o pressionar","Encerrar sem despedida","Deixar o cliente confuso"], correctIndex:0},
      {question:"Qual deve ser a frequ√™ncia de contato ap√≥s a visita?", options:["Nenhum contato para n√£o incomodar","Regular, mas respeitando o tempo do lojista","Ligar todos os dias sem parar","Mandar apenas mensagens de vendas"], correctIndex:1},
      {question:"O que n√£o deve ser feito ao falar de concorrentes?", options:["Valorizar seus diferenciais","Falar mal e desmerecer","Reconhecer que o cliente j√° tem parceiro","Mostrar alternativas melhores"], correctIndex:1},
      {question:"Qual atitude demonstra profissionalismo?", options:["Postura carism√°tica e organizada","Improvisar sempre","Esquecer material de vendas","Vestir roupas informais"], correctIndex:0},
      {question:"Por que enviar mensagem ap√≥s a visita?", options:["Para agradecer e refor√ßar lembran√ßa","Para pressionar o cliente","Para tentar fechar imediatamente","Para encerrar contato"], correctIndex:0},
      {question:"Em rela√ß√£o ao tempo do lojista, o vendedor deve:", options:["Valorizar cada minuto e ser objetivo","Falar o m√°ximo poss√≠vel","Esperar at√© ser ignorado","Interromper constantemente"], correctIndex:0},
      {question:"Um checklist de vendedor externo ajuda em qu√™?", options:["Organizar visitas e aumentar produtividade","Tornar o trabalho mais dif√≠cil","Diminuir controle de metas","Evitar contato com lojistas"], correctIndex:0},

      // 31‚Äì80 (Kahoot 50)
      {question:"Qual √© o foco principal da SouFacil?", options:["Aumentar vendas e crescimento do lojista","Reduzir custos de fornecedores","Vender produtos f√≠sicos","Criar franquias"], correctIndex:0},
      {question:"Qual √© o servi√ßo principal da SouFacil?", options:["Cart√£o de cr√©dito pr√≥prio","Credi√°rio no boleto","Empr√©stimos pessoais","Maquininha de cart√£o"], correctIndex:1},
      {question:"O que a SouFacil garante ao lojista no credi√°rio?", options:["Pagamento apenas se o cliente pagar","Garantia de recebimento","Reembolso ap√≥s 90 dias","Parcelamento sem juros"], correctIndex:1},
      {question:"Um dos diferenciais da SouFacil √©:", options:["Aprova√ß√£o demorada","Processo 100% digital","Alta burocracia","Exigir renda comprovada"], correctIndex:1},
      {question:"Qual √© a principal vantagem para o lojista usar SouFacil?", options:["Aumentar inadimpl√™ncia","Garantir recebimento","Reduzir estoque","Evitar clientes"], correctIndex:1},
      {question:"O credi√°rio da SouFacil permite parcelar compras em:", options:["Cheque","Boleto","PIX","D√©bito autom√°tico"], correctIndex:1},
      {question:"O lojista recebe o valor da venda:", options:["Apenas se o cliente pagar","Sempre, independente do cliente","6 meses depois","Em vale-compras"], correctIndex:1},
      {question:"A an√°lise de cr√©dito da SouFacil √© feita com:", options:["CPF e telefone","Holerite e comprovante de endere√ßo","Certid√£o de nascimento","Declara√ß√£o de imposto de renda"], correctIndex:0},
      {question:"Qual o tempo m√©dio da aprova√ß√£o de cr√©dito?", options:["Horas","Segundos","Dias","Semanas"], correctIndex:1},
      {question:"Quais documentos o cliente precisa levar?", options:["Apenas documento com foto","RG, CPF, holerite, comprovante de resid√™ncia","Carteira de trabalho","Nenhum documento"], correctIndex:0},
      {question:"A taxa de juros varia entre:", options:["2% a 3%","5,49% a 7,99%","10% a 15%","1% fixo"], correctIndex:1},
      {question:"Em uma compra de R$ 1.000 em 10x com 5,99% de juros, quanto o cliente pagar√° por parcela?", options:["R$ 100,00","R$ 159,90","R$ 120,00","R$ 200,00"], correctIndex:1},
      {question:"Quanto maior a quantidade de parcelas:", options:["Menor o valor total","Maior o valor total","O valor n√£o muda","O lojista perde o pagamento"], correctIndex:1},
      {question:"Quem paga os juros?", options:["Sempre o lojista","Sempre o cliente","Depende da configura√ß√£o do sistema","O governo"], correctIndex:2},
      {question:"O sistema da SouFacil adiciona os juros:", options:["Ap√≥s o cliente pagar","No momento da compra","No fechamento do m√™s","Na entrega do produto"], correctIndex:1},
      {question:"O que √© o SouFacil Card?", options:["Cart√£o de cr√©dito tradicional","Cart√£o de marca pr√≥pria para lojistas","Vale-alimenta√ß√£o","Cart√£o de d√©bito pr√©-pago"], correctIndex:1},
      {question:"Qual o limite inicial do cart√£o?", options:["R$ 100","R$ 300","R$ 500","R$ 1.000"], correctIndex:1},
      {question:"Qual o limite m√°ximo do cart√£o?", options:["R$ 1.000","R$ 1.200","R$ 1.500","R$ 2.000"], correctIndex:2},
      {question:"O aumento do limite √© feito em:", options:["+5% ao m√™s","+20% ao m√™s","+10% ao m√™s","De acordo com o lojista"], correctIndex:1},
      {question:"O cart√£o ajuda o lojista a:", options:["Fidelizar clientes","Reduzir vendas","Trocar de bandeira","Evitar promo√ß√µes"], correctIndex:0},
      {question:"O SouFacil Card garante:", options:["Recebimento mesmo sem pagamento","Pagamento s√≥ √† vista","Risco de inadimpl√™ncia","Menos vendas"], correctIndex:0},
      {question:"Qual a mensalidade do cart√£o para o cliente?", options:["R$ 14,90","R$ 9,90","R$ 19,90","Zero"], correctIndex:0},
      {question:"Se o cliente n√£o usar o cart√£o, ele paga mensalidade?", options:["Sim, sempre","N√£o","Depende do lojista","S√≥ paga 50%"], correctIndex:1},
      {question:"Qual o investimento inicial para o lojista implantar o cart√£o?", options:["R$ 1.000 (500 plataforma + 500 marketing)","R$ 200","R$ 5.000","Zero"], correctIndex:0},
      {question:"Qual a mensalidade para o lojista manter o cart√£o?", options:["R$ 100","R$ 150","R$ 200","R$ 300"], correctIndex:1},
      {question:"Qual o valor do pacote de 150 cart√µes?", options:["R$ 500","R$ 750","R$ 1.000","R$ 1.500"], correctIndex:0},
      {question:"Qual o valor do pacote de 300 cart√µes?", options:["R$ 1.000","R$ 750","R$ 500","R$ 2.000"], correctIndex:1},
      {question:"Qual o valor do pacote de 500 cart√µes?", options:["R$ 1.000","R$ 1.500","R$ 750","R$ 2.500"], correctIndex:0},
      {question:"O valor de um cart√£o avulso √©:", options:["R$ 1,99","R$ 4,99","R$ 9,99","R$ 14,99"], correctIndex:1},
      {question:"O cliente recebe o cart√£o f√≠sico:", options:["Pelo correio","Diretamente na loja","Apenas no celular","No banco"], correctIndex:1},
      {question:"Qual √© o valor de bonifica√ß√£o por cart√£o ativo?", options:["R$ 10,00","R$ 5,00","R$ 2,00","R$ 1,00"], correctIndex:1},
      {question:"Para receber a bonifica√ß√£o, o cliente precisa:", options:["Comprar pelo menos R$ 50","Comprar qualquer valor","Apenas ativar o cart√£o","Usar por 1 ano"], correctIndex:0},
      {question:"Quando ocorre o pagamento da bonifica√ß√£o?", options:["Todo dia 1","Todo dia 10","Todo dia 15","Todo dia 30"], correctIndex:1},
      {question:"Se cair no feriado ou final de semana, o pagamento ocorre:", options:["No mesmo dia","No pr√≥ximo dia √∫til","S√≥ no m√™s seguinte","N√£o √© pago"], correctIndex:1},
      {question:"O vendedor precisa estar:", options:["Cadastrado no sistema","Ligado a um banco","Registrado em cart√≥rio","Apenas indicar clientes"], correctIndex:0},
      {question:"Qual a taxa de 1 parcela no cart√£o?", options:["2,5%","3,5%","4,5%","5,5%"], correctIndex:2},
      {question:"Qual a taxa de 2 a 3 parcelas?", options:["4,5%","5,5%","6,5%","7,5%"], correctIndex:1},
      {question:"Qual a taxa de 4 a 5 parcelas?", options:["5,5%","6,5%","7,5%","8,5%"], correctIndex:1},
      {question:"Essas taxas podem ser:", options:["Apenas repassadas ao cliente","Apenas absorvidas pelo lojista","Repassadas ou absorvidas","N√£o existem taxas"], correctIndex:2},
      {question:"Os repasses financeiros s√£o feitos:", options:["Todo dia","Toda semana","A cada 6 meses","Apenas no fim do ano"], correctIndex:1},
      {question:"A consulta do cliente √© feita em:", options:["Segundos","Minutos","Horas","Dias"], correctIndex:0},
      {question:"Ap√≥s o cadastro, o cliente recebe:", options:["E-mail","Notifica√ß√£o com link para reconhecimento facial","Carta pelos correios","Telefone de confirma√ß√£o"], correctIndex:1},
      {question:"O n√∫mero do cart√£o √© enviado:", options:["Por SMS","Por WhatsApp","Por e-mail","Pelo lojista"], correctIndex:1},
      {question:"O cart√£o precisa ser:", options:["Desbloqueado","Recarregado","Renovado a cada ano","Trocado no banco"], correctIndex:0},
      {question:"As compras vencem:", options:["30 dias ap√≥s","Na mesma data no m√™s seguinte","A cada 45 dias","Somente no fechamento anual"], correctIndex:1},
      {question:"O SouFacil ajuda o lojista a:", options:["Vender mais","Vender menos","Perder clientes","Aumentar inadimpl√™ncia"], correctIndex:0},
      {question:"Para o cliente final, o benef√≠cio √©:", options:["Mais burocracia","Mais formas de pagamento","Menos op√ß√µes","Apenas cr√©dito √† vista"], correctIndex:1},
      {question:"O credi√°rio no boleto √© importante porque:", options:["Muitos n√£o t√™m cart√£o de cr√©dito","Os clientes preferem cheque","S√≥ funciona em bancos","√â mais caro sempre"], correctIndex:0},
      {question:"A SouFacil pode ser considerada:", options:["Uma parceira do lojista","Uma concorrente","Um banco tradicional","Uma empresa de cobran√ßa"], correctIndex:0},
      {question:"Qual slogan resume a SouFacil?", options:["Mais burocracia, menos vendas","Solu√ß√µes financeiras para vender mais","S√≥ para grandes empresas","Parcelamento apenas no cart√£o"], correctIndex:1}
    ];

    // üîß Estado e utilit√°rios
    const $ = (s)=>document.querySelector(s);
    const el = (tag, attrs={}, children=[])=>{const e=document.createElement(tag);for(const k in attrs){if(k==='class')e.className=attrs[k];else if(k==='html')e.innerHTML=attrs[k];else e.setAttribute(k,attrs[k]);}children.forEach(c=>e.appendChild(c));return e};
    const uid = ()=>Math.random().toString(36).slice(2,10);

    // üî• Firebase init
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const state = { role:null, room:null, hostId:null, playerId:null, duration:30, base:1000, unsubRoom:null, unsubPlayers:null };

    // Host: criar sala com perguntas embutidas em subcole√ß√£o
    async function hostCreateRoom(){
      state.duration = Math.max(5, parseInt($('#qDuration').value||30));
      state.base = Math.max(100, parseInt($('#baseScore').value||1000));
      const code = ($('#roomCode').value||'').trim().toUpperCase() || ('SF'+uid().slice(0,5)).toUpperCase();
      const hostName = ($('#hostName').value||'Host').trim();
      const ref = db.collection('rooms').doc(code);
      await ref.set({createdAt: Date.now(), status:'lobby', currentIndex:-1, duration: state.duration, base: state.base, qCount: BUILTIN_QUESTIONS.length, hostName, startedAt:null});
      // Salva perguntas
      const batch = db.batch();
      BUILTIN_QUESTIONS.forEach((q,idx)=>{ batch.set(ref.collection('questions').doc(String(idx)), q); });
      await batch.commit();
      state.role='host'; state.room=code; state.hostId=uid();
      $('#hostInfo').innerHTML = `Sala <b>${code}</b> criada. Compartilhe o c√≥digo com os jogadores.`;
      $('#btnStart').disabled=false; $('#btnNext').disabled=true; $('#btnEnd').disabled=false;
      subscribeRoomForHost(code); subscribePlayers(code);
    }

    async function pushQuestion(idx){
      const ref = db.collection('rooms').doc(state.room);
      await ref.update({ currentIndex: idx, status:'question', startedAt: Date.now() });
    }

    function subscribeRoomForHost(code){
      if(state.unsubRoom) state.unsubRoom();
      state.unsubRoom = db.collection('rooms').doc(code).onSnapshot(async snap=>{
        const r = snap.data(); if(!r) return;
        const qWrap = $('#liveQuestion'); qWrap.innerHTML='';
        if(r.currentIndex>=0){
          const qDoc = await snap.ref.collection('questions').doc(String(r.currentIndex)).get();
          const q = qDoc.data();
          qWrap.appendChild(el('div',{html:`<div class='pill'>Pergunta ${r.currentIndex+1}/${r.qCount}</div><h2>${q.question}</h2>`}));
          const stats = await snap.ref.collection('players').get();
          const total = stats.size;
          const answered = stats.docs.filter(d=> (d.data().lastIndex===r.currentIndex)).length;
          $('#liveStats').innerHTML = `Respondidas: <b>${answered}</b> / ${total}`;
        } else {
          $('#liveStats').innerHTML = 'Sala no lobby.';
        }
      });
    }

    function subscribePlayers(code){
      if(state.unsubPlayers) state.unsubPlayers();
      state.unsubPlayers = db.collection('rooms').doc(code).collection('players')
        .orderBy('score','desc').onSnapshot(snap=>{
          const arr = snap.docs.map(d=>d.data());
          const hostLb = $('#hostLeaderboard'); hostLb.innerHTML='';
          const wrap = el('div');
          arr.slice(0,10).forEach((p,i)=>{
            wrap.appendChild(el('div',{class:'leader'},[
              el('div',{class:'pill',html:'#'+(i+1)}),
              el('div',{html:`<b>${p.name}</b>`}),
              el('div',{html:`<div class='pill'>${p.score} pts</div>`}),
            ]));
          });
          hostLb.appendChild(wrap);
        });
    }

    // Host UI buttons
    $('#btnInitHost').onclick = hostCreateRoom;
    $('#btnStart').onclick = ()=> pushQuestion(0);
    $('#btnNext').onclick = async ()=>{
      const ref = db.collection('rooms').doc(state.room); const snap = await ref.get(); const r=snap.data();
      const next = r.currentIndex + 1; if(next < r.qCount) await pushQuestion(next); else await ref.update({status:'ended'});
    };
    $('#btnEnd').onclick = async ()=>{ if(!state.room) return; await db.collection('rooms').doc(state.room).update({status:'ended'}); };

    // Habilitar Pr√≥xima quando todo mundo respondeu ou tempo acabou
    setInterval(async ()=>{
      if(state.role!== 'host' || !state.room) return;
      const ref = db.collection('rooms').doc(state.room); const snap = await ref.get(); if(!snap.exists) return; const r=snap.data();
      if(r.status==='question'){
        const dur = (r.duration||30)*1000; const endAt = (r.startedAt||0)+dur; const now=Date.now();
        const pSnap = await ref.collection('players').get(); const total = pSnap.size; const answered = pSnap.docs.filter(d=> d.data().lastIndex===r.currentIndex).length;
        $('#btnNext').disabled = (now < endAt) && (answered < total && total>0);
      }
    }, 1000);

    // Jogador
    function setView(id){ ['phaseLobby','phaseQuestion','phaseFeedback','phaseEnd'].forEach(v=>{const e=document.getElementById(v); if(e) e.classList.add('hidden');}); const t=document.getElementById(id); if(t) t.classList.remove('hidden'); }
    function renderTimer(msLeft,total){ const pct=Math.max(0,Math.min(100,(msLeft/total)*100)); return `<div class="timer"><div style="width:${pct}%"></div></div>`; }

    $('#btnInitPlayer').onclick = ()=>{ $('#btnJoin').disabled=false; alert('Conectado. Digite o c√≥digo da sala e seu nome.'); };

    $('#btnJoin').onclick = async ()=>{
      const code = ($('#joinRoom').value||'').trim().toUpperCase(); const name = ($('#playerName').value||'').trim() || 'Jogador';
      if(!code) return alert('Digite o c√≥digo da sala.');
      const roomRef = db.collection('rooms').doc(code); const roomSnap = await roomRef.get(); if(!roomSnap.exists) return alert('Sala n√£o encontrada.');
      state.role='player'; state.room=code; state.playerId=uid();
      await roomRef.collection('players').doc(state.playerId).set({ id: state.playerId, name, score:0, lastIndex:-1, correct:false, answeredAt:null, joinedAt: Date.now() });
      watchRoomAsPlayer(); $('#btnJoin').disabled=true; $('#phaseLobby').innerHTML=`Conectado √† sala <b>${code}</b>. Aguarde o apresentador.`;
    };

    function watchRoomAsPlayer(){
      const rRef = db.collection('rooms').doc(state.room);
      if(state.unsubRoom) state.unsubRoom();
      state.unsubRoom = rRef.onSnapshot(async snap=>{
        const r = snap.data(); if(!r) return;
        if(r.status==='lobby'){ setView('phaseLobby'); return; }
        if(r.status==='ended'){ setView('phaseEnd'); $('#phaseEnd').innerHTML='<h2>Jogo encerrado</h2>'; return; }
        const qRef = rRef.collection('questions').doc(String(r.currentIndex)); const qDoc = await qRef.get(); const q = qDoc.data();
        const dur = (r.duration||30)*1000; const endAt = (r.startedAt||Date.now()) + dur; const now=Date.now(); const msLeft = endAt-now;
        setView('phaseQuestion');
        const wrap = $('#phaseQuestion'); const already = window.localStorage.getItem('ans-'+state.room+'-'+r.currentIndex) === '1';
        wrap.innerHTML = `<div class='pill'>Pergunta ${r.currentIndex+1}/${r.qCount}</div><h2>${q.question}</h2><div id='timerWrap'>${renderTimer(msLeft,dur)}</div><div class='grid cols-2' id='ops'></div><div class='muted'>Voc√™ s√≥ pode responder uma vez.</div>`;
        const ops = $('#ops'); q.options.forEach((op,i)=>{ const d=el('div',{class:'option',html:op}); d.onclick = async ()=>{
            if(already) return; const timeNow=Date.now(); const inTime = timeNow < endAt; let score = 0; let correct=false; if(inTime && i===q.correctIndex){ const remain = endAt - timeNow; const bonus = Math.max(0, Math.floor((remain/dur) * (r.base||1000)*0.5)); score = (r.base||1000) + bonus; correct=true; }
            await rRef.collection('players').doc(state.playerId).set({ lastIndex:r.currentIndex, answeredAt: timeNow, correct, score: firebase.firestore.FieldValue.increment(score) }, {merge:true});
            window.localStorage.setItem('ans-'+state.room+'-'+r.currentIndex,'1'); setView('phaseFeedback'); $('#phaseFeedback').innerHTML = `<h2>${correct?'‚úÖ Acertou!':'‚ùå Errou'}</h2><div class='muted'>${correct?('+'+score+' pts'):'Tente a pr√≥xima'}</div>`;
          }; ops.appendChild(d); });
        const tEl = document.getElementById('timerWrap'); const tick=()=>{ const ms=endAt-Date.now(); tEl.innerHTML=renderTimer(ms,dur); if(ms>0) requestAnimationFrame(tick); else $('#phaseFeedback').classList.remove('hidden'); }; requestAnimationFrame(tick);
      });
    }
  </script>
</body>
</html>
