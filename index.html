<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SouF√°cil Quiz ‚Äî Online (20s)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{--bg:#071127;--card:#0f1624;--muted:#9aa9bf;--brand:#36bdf0;--ok:#22c55e;--bad:#ef4444}
  *{box-sizing:border-box}body{margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,#061025,#071127);color:#e6eef8;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:18px}
  .wrap{max-width:1000px;width:100%;background:linear-gradient(180deg,rgba(255,255,255,.02),transparent);border-radius:14px;padding:18px;border:1px solid rgba(255,255,255,.03)}
  h1{margin:0 0 6px;font-size:20px;display:flex;gap:10px;align-items:center}
  .muted{color:var(--muted);font-size:13px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1 1 320px}
  input,button,select,textarea{font:inherit}
  input{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.04);background:transparent;color:inherit}
  .btn{background:var(--brand);color:#001018;padding:10px 12px;border-radius:10px;border:0;font-weight:700;cursor:pointer}
  .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,.06);color:inherit}
  .card{background:rgba(255,255,255,.02);padding:14px;border-radius:10px;border:1px solid rgba(255,255,255,.02)}
  .options{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:12px}
  .option{padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,.03);background:transparent;cursor:pointer}
  .option.disabled{opacity:.5;pointer-events:none}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.03);font-weight:700}
  .timer{height:10px;background:rgba(255,255,255,.04);border-radius:999px;overflow:hidden;margin-top:8px}
  .timer>div{height:100%;background:linear-gradient(90deg,#36bdf0,#6ea8ff);width:0%}
  .list{margin-top:10px;max-height:160px;overflow:auto}
  .lc{display:flex;justify-content:space-between;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,.02);margin-bottom:6px}
  .center{display:flex;align-items:center;justify-content:center}
  .hidden{display:none}
  .small{font-size:13px;color:var(--muted)}
  footer{margin-top:10px;font-size:12px;color:var(--muted)}
</style>
</head>
<body>
  <div class="wrap">
    <h1>‚ö° SouF√°cil Quiz ‚Äî 20s por pergunta <span class="pill">Modo livre</span></h1>
    <div class="muted">Abra este arquivo num servidor (ou local) e compartilhe o link. Todos entram com o nome e qualquer um pode iniciar o jogo.</div>
    <div style="height:12px"></div>

    <div class="row">
      <div class="col card">
        <h2 style="margin:0;font-size:16px">Entrar / Sala</h2>
        <div style="height:8px"></div>
        <label class="small">C√≥digo da sala (qualquer texto)</label>
        <input id="roomInput" placeholder="ex: SOUFACIL01"/>
        <div style="height:6px"></div>
        <label class="small">Seu nome</label>
        <input id="nameInput" placeholder="ex: Maria"/>
        <div style="height:8px"></div>
        <div class="row">
          <button class="btn" id="btnJoin">Entrar na sala</button>
          <button class="btn secondary" id="btnStart" disabled>Iniciar (apenas um clique)</button>
        </div>
        <div style="height:8px"></div>
        <div id="joinedInfo" class="small">Ainda n√£o entrou em nenhuma sala.</div>

        <div style="height:10px"></div>
        <div class="separator"></div>
        <div style="height:8px"></div>
        <div>
          <div class="small">Jogadores na sala</div>
          <div id="playersList" class="list"></div>
        </div>
      </div>

      <div class="col card">
        <h2 style="margin:0;font-size:16px">Pergunta atual</h2>
        <div id="statusArea" style="margin-top:8px" class="small">Aguardando in√≠cio...</div>

        <div id="questionArea" class="hidden">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div class="pill" id="qIndex">Pergunta 1/80</div>
            <div class="small">Tempo restante: <span id="timeLeft">20</span>s</div>
          </div>

          <h3 id="qText" style="margin:8px 0 0 0"></h3>
          <div class="timer"><div id="timerBar" style="width:0%"></div></div>
          <div class="options" id="optionsWrap"></div>

          <div style="height:10px"></div>
          <div class="small">Resumo da pergunta (aparece quando o tempo acabar):</div>
          <div id="summaryArea" class="list small"></div>
        </div>

        <div id="endArea" class="hidden">
          <h3>üèÅ Jogo finalizado</h3>
          <div class="small">Ranking final:</div>
          <div id="finalRanking" class="list"></div>
          <div style="height:8px"></div>
          <button class="btn" id="btnRestartLocal">Reiniciar local (mesma sala)</button>
        </div>
      </div>
    </div>

    <footer>Observa√ß√£o: para testes, configure o Realtime Database em modo teste no console do Firebase.</footer>
  </div>

  <!-- Firebase Realtime Database compat -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
  /***** CONFIG (j√° preenchida com suas chaves) *****/
  const firebaseConfig = {
    apiKey: "AIzaSyAns0NBLW8JTmLFRuOSLz16tAXrKuox9rU",
    authDomain: "comercial-92085.firebaseapp.com",
    projectId: "comercial-92085",
    storageBucket: "comercial-92085.firebasestorage.app",
    messagingSenderId: "1086266528954",
    appId: "1:1086266528954:web:91dfc7975e79c5cc141e83"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  /***** Perguntas embutidas (j√° todas as 80) *****/
  // Formato: {question: "...", options: ["A","B","C","D"], correctIndex: n}
  const QUESTIONS = [
    {question:"Qual √© a postura correta ao chegar em uma loja para a primeira abordagem?", options:["Mexer no celular para parecer ocupado","Chegar sorrindo e mantendo contato visual","Ficar em sil√™ncio at√© o lojista falar primeiro","Sentar-se sem pedir permiss√£o"], correctIndex:1},
    {question:"O que √© essencial para passar uma boa primeira impress√£o?", options:["Falar r√°pido para encurtar a conversa","Ter uniforme limpo e bem passado","Usar acess√≥rios chamativos","For√ßar uma venda imediata"], correctIndex:1},
    {question:"Qual deve ser o tom de voz usado na abordagem?", options:["Alto e autorit√°rio","Claro, aud√≠vel e modulado","Baixo e quase inaud√≠vel","R√°pido e apressado"], correctIndex:1},
    {question:"O que significa escuta ativa?", options:["Interromper o cliente para corrigir","Repetir g√≠rias para criar proximidade","Prestar aten√ß√£o, confirmar e resumir o que o cliente disse","Deixar o cliente falar sem responder"], correctIndex:2},
    {question:"Antes da visita, o que N√ÉO faz parte do planejamento?", options:["Pesquisar sobre o lojista","Preparar material de apoio","Planejar rota","Improvisar totalmente na hora"], correctIndex:3},
    {question:"Durante a visita, qual √© a melhor forma de iniciar a conversa?", options:["Com um quebra-gelo ou elogio sincero","Perguntando direto sobre vendas","Entregando contrato de imediato","Falando mal de concorrentes"], correctIndex:0},
    {question:"Se o lojista disser ‚Äòj√° trabalho com outra financeira‚Äô, a melhor resposta √©:", options:["Ent√£o n√£o preciso explicar","Nossos clientes tamb√©m usavam outras, mas migraram pelos nossos diferenciais","A concorr√™ncia √© ruim, s√≥ n√≥s prestamos","Se mudar de ideia me procure"], correctIndex:1},
    {question:"Qual item √© essencial ap√≥s a visita?", options:["Esquecer o que foi conversado","Enviar mensagem de agradecimento","Evitar contato para n√£o incomodar","Esperar o cliente ligar"], correctIndex:1},
    {question:"Qual deve ser o foco principal da apresenta√ß√£o?", options:["Caracter√≠sticas do produto","Benef√≠cios para o lojista","Falar apenas sobre pre√ßo","Criticar concorrentes"], correctIndex:1},
    {question:"Qual vestimenta √© adequada para homens?", options:["Cal√ßa rasgada, camiseta colorida","Uniforme bem passado e cores neutras","Bon√© e chinelo","Roupas informais e chamativas"], correctIndex:1},
    {question:"Qual vestimenta √© adequada para mulheres?", options:["Roupas curtas e coloridas","Uniforme bem passado, cores neutras e cabelo arrumado","Maquiagem exagerada","Sand√°lia de praia"], correctIndex:1},
    {question:"Se o lojista disser ‚Äòest√° caro‚Äô, qual √© a melhor resposta?", options:["Ent√£o n√£o compre","Entendo, mas veja o retorno que voc√™ ter√°","√â o pre√ßo que temos, n√£o tem o que fazer","Se n√£o quiser, eu saio"], correctIndex:1},
    {question:"O que √© recomendado levar sempre na visita?", options:["Material de vendas completo","Apenas celular","Nada, para n√£o parecer insistente","Apenas cart√£o pessoal"], correctIndex:0},
    {question:"Qual a melhor postura corporal durante a abordagem?", options:["Bra√ßos cruzados","De p√©, postura aberta e receptiva","De costas para o lojista","Sempre sentado"], correctIndex:1},
    {question:"Ap√≥s o lojista dizer ‚Äòpreciso conversar com meu s√≥cio‚Äô, o vendedor deve:", options:["Encerrar a visita imediatamente","Oferecer preparar resumo para o s√≥cio","Dizer que n√£o √© necess√°rio","Pressionar para decidir sozinho"], correctIndex:1},
    {question:"Qual a vantagem de usar perguntas abertas?", options:["Fecham a conversa mais r√°pido","Estimulam o lojista a falar mais","Limitam as respostas a sim/n√£o","Desgastam a paci√™ncia do cliente"], correctIndex:1},
    {question:"O que significa adaptar a linguagem ao perfil do lojista?", options:["Falar dif√≠cil para parecer inteligente","Usar sempre g√≠rias","Ajustar vocabul√°rio de acordo com o cliente","Falar apenas sobre pre√ßo"], correctIndex:2},
    {question:"O que deve ser feito logo ap√≥s sair da loja?", options:["Atualizar lista de visitas e registrar informa√ß√µes","Esquecer para n√£o ocupar mem√≥ria","N√£o anotar nada","Esperar a pr√≥xima semana para lembrar"], correctIndex:0},
    {question:"Se o lojista n√£o estiver interessado, a melhor atitude √©:", options:["For√ßar a venda at√© ele aceitar","Perguntar o que n√£o interessou e anotar feedback","Encerrar sem agradecer","Deixar de lado e nunca mais voltar"], correctIndex:1},
    {question:"Qual √© um diferencial da SouFacil?", options:["Aprova√ß√£o sem burocracia","Vendas apenas √† vista","Taxa fixa e alta para todos","N√£o oferecer parcelamento"], correctIndex:0},

    // Kahoot 50 (continuando)
    {question:"Qual √© o foco principal da SouFacil?", options:["Aumentar vendas e crescimento do lojista","Reduzir custos de fornecedores","Vender produtos f√≠sicos","Criar franquias"], correctIndex:0},
    {question:"Qual √© o servi√ßo principal da SouFacil?", options:["Cart√£o de cr√©dito pr√≥prio","Credi√°rio no boleto","Empr√©stimos pessoais","Maquininha de cart√£o"], correctIndex:1},
    {question:"O que a SouFacil garante ao lojista no credi√°rio?", options:["Pagamento apenas se o cliente pagar","Garantia de recebimento","Reembolso ap√≥s 90 dias","Parcelamento sem juros"], correctIndex:1},
    {question:"Um dos diferenciais da SouFacil √©:", options:["Aprova√ß√£o demorada","Processo 100% digital","Alta burocracia","Exigir renda comprovada"], correctIndex:1},
    {question:"Qual √© a principal vantagem para o lojista usar SouFacil?", options:["Aumentar inadimpl√™ncia","Garantir recebimento","Reduzir estoque","Evitar clientes"], correctIndex:1},
    {question:"O credi√°rio da SouFacil permite parcelar compras em:", options:["Cheque","Boleto","PIX","D√©bito autom√°tico"], correctIndex:1},
    {question:"O lojista recebe o valor da venda:", options:["Apenas se o cliente pagar","Sempre, independente do cliente","6 meses depois","Em vale-compras"], correctIndex:1},
    {question:"A an√°lise de cr√©dito da SouFacil √© feita com:", options:["CPF e telefone","Holerite e comprovante de endere√ßo","Certid√£o de nascimento","Declara√ß√£o de imposto de renda"], correctIndex:0},
    {question:"Qual o tempo m√©dio da aprova√ß√£o de cr√©dito?", options:["Horas","Segundos","Dias","Semanas"], correctIndex:1},
    {question:"Quais documentos o cliente precisa levar?", options:["Apenas documento com foto","RG, CPF, holerite, comprovante de resid√™ncia","Carteira de trabalho","Nenhum documento"], correctIndex:0},
    {question:"A taxa de juros varia entre:", options:["2% a 3%","5,49% a 7,99%","10% a 15%","1% fixo"], correctIndex:1},
    {question:"Em uma compra de R$ 1.000 em 10x com 5,99% de juros, quanto o cliente pagar√° por parcela?", options:["R$ 100,00","R$ 159,90","R$ 120,00","R$ 200,00"], correctIndex:1},
    {question:"Quanto maior a quantidade de parcelas:", options:["Menor o valor total","Maior o valor total","O valor n√£o muda","O lojista perde o pagamento"], correctIndex:1},
    {question:"Quem paga os juros?", options:["Sempre o lojista","Sempre o cliente","Depende da configura√ß√£o do sistema","O governo"], correctIndex:2},
    {question:"O sistema da SouFacil adiciona os juros:", options:["Ap√≥s o cliente pagar","No momento da compra","No fechamento do m√™s","Na entrega do produto"], correctIndex:1},
    {question:"O que √© o SouFacil Card?", options:["Cart√£o de cr√©dito tradicional","Cart√£o de marca pr√≥pria para lojistas","Vale-alimenta√ß√£o","Cart√£o de d√©bito pr√©-pago"], correctIndex:1},
    {question:"Qual o limite inicial do cart√£o?", options:["R$ 100","R$ 300","R$ 500","R$ 1.000"], correctIndex:1},
    {question:"Qual o limite m√°ximo do cart√£o?", options:["R$ 1.000","R$ 1.200","R$ 1.500","R$ 2.000"], correctIndex:2},
    {question:"O aumento do limite √© feito em:", options:["+5% ao m√™s","+20% ao m√™s","+10% ao m√™s","De acordo com o lojista"], correctIndex:1},
    {question:"O cart√£o ajuda o lojista a:", options:["Fidelizar clientes","Reduzir vendas","Trocar de bandeira","Evitar promo√ß√µes"], correctIndex:0},
    {question:"O SouFacil Card garante:", options:["Recebimento mesmo sem pagamento","Pagamento s√≥ √† vista","Risco de inadimpl√™ncia","Menos vendas"], correctIndex:0},
    {question:"Qual a mensalidade do cart√£o para o cliente?", options:["R$ 14,90","R$ 9,90","R$ 19,90","Zero"], correctIndex:0},
    {question:"Se o cliente n√£o usar o cart√£o, ele paga mensalidade?", options:["Sim, sempre","N√£o","Depende do lojista","S√≥ paga 50%"], correctIndex:1},
    {question:"Qual o investimento inicial para o lojista implantar o cart√£o?", options:["R$ 1.000 (500 plataforma + 500 marketing)","R$ 200","R$ 5.000","Zero"], correctIndex:0},
    {question:"Qual a mensalidade para o lojista manter o cart√£o?", options:["R$ 100","R$ 150","R$ 200","R$ 300"], correctIndex:1},
    {question:"Qual o valor do pacote de 150 cart√µes?", options:["R$ 500","R$ 750","R$ 1.000","R$ 1.500"], correctIndex:0},
    {question:"Qual o valor do pacote de 300 cart√µes?", options:["R$ 1.000","R$ 750","R$ 500","R$ 2.000"], correctIndex:1},
    {question:"Qual o valor do pacote de 500 cart√µes?", options:["R$ 1.000","R$ 1.500","R$ 750","R$ 2.500"], correctIndex:0},
    {question:"O valor de um cart√£o avulso √©:", options:["R$ 1,99","R$ 4,99","R$ 9,99","R$ 14,99"], correctIndex:1},
    {question:"O cliente recebe o cart√£o f√≠sico:", options:["Pelo correio","Diretamente na loja","Apenas no celular","No banco"], correctIndex:1},
    {question:"Qual √© o valor de bonifica√ß√£o por cart√£o ativo?", options:["R$ 10,00","R$ 5,00","R$ 2,00","R$ 1,00"], correctIndex:1},
    {question:"Para receber a bonifica√ß√£o, o cliente precisa:", options:["Comprar pelo menos R$ 50","Comprar qualquer valor","Apenas ativar o cart√£o","Usar por 1 ano"], correctIndex:0},
    {question:"Quando ocorre o pagamento da bonifica√ß√£o?", options:["Todo dia 1","Todo dia 10","Todo dia 15","Todo dia 30"], correctIndex:1},
    {question:"Se cair no feriado ou final de semana, o pagamento ocorre:", options:["No mesmo dia","No pr√≥ximo dia √∫til","S√≥ no m√™s seguinte","N√£o √© pago"], correctIndex:1},
    {question:"O vendedor precisa estar:", options:["Cadastrado no sistema","Ligado a um banco","Registrado em cart√≥rio","Apenas indicar clientes"], correctIndex:0},
    {question:"Qual a taxa de 1 parcela no cart√£o?", options:["2,5%","3,5%","4,5%","5,5%"], correctIndex:2},
    {question:"Qual a taxa de 2 a 3 parcelas?", options:["4,5%","5,5%","6,5%","7,5%"], correctIndex:1},
    {question:"Qual a taxa de 4 a 5 parcelas?", options:["5,5%","6,5%","7,5%","8,5%"], correctIndex:1},
    {question:"Essas taxas podem ser:", options:["Apenas repassadas ao cliente","Apenas absorvidas pelo lojista","Repassadas ou absorvidas","N√£o existem taxas"], correctIndex:2},
    {question:"Os repasses financeiros s√£o feitos:", options:["Todo dia","Toda semana","A cada 6 meses","Apenas no fim do ano"], correctIndex:1},
    {question:"A consulta do cliente √© feita em:", options:["Segundos","Minutos","Horas","Dias"], correctIndex:0},
    {question:"Ap√≥s o cadastro, o cliente recebe:", options:["E-mail","Notifica√ß√£o com link para reconhecimento facial","Carta pelos correios","Telefone de confirma√ß√£o"], correctIndex:1},
    {question:"O n√∫mero do cart√£o √© enviado:", options:["Por SMS","Por WhatsApp","Por e-mail","Pelo lojista"], correctIndex:1},
    {question:"O cart√£o precisa ser:", options:["Desbloqueado","Recarregado","Renovado a cada ano","Trocado no banco"], correctIndex:0},
    {question:"As compras vencem:", options:["30 dias ap√≥s","Na mesma data no m√™s seguinte","A cada 45 dias","Somente no fechamento anual"], correctIndex:1},
    {question:"O SouFacil ajuda o lojista a:", options:["Vender mais","Vender menos","Perder clientes","Aumentar inadimpl√™ncia"], correctIndex:0},
    {question:"Para o cliente final, o benef√≠cio √©:", options:["Mais burocracia","Mais formas de pagamento","Menos op√ß√µes","Apenas cr√©dito √† vista"], correctIndex:1},
    {question:"O credi√°rio no boleto √© importante porque:", options:["Muitos n√£o t√™m cart√£o de cr√©dito","Os clientes preferem cheque","S√≥ funciona em bancos","√â mais caro sempre"], correctIndex:0},
    {question:"A SouFacil pode ser considerada:", options:["Uma parceira do lojista","Uma concorrente","Um banco tradicional","Uma empresa de cobran√ßa"], correctIndex:0},
    {question:"Qual slogan resume a SouFacil?", options:["Mais burocracia, menos vendas","Solu√ß√µes financeiras para vender mais","S√≥ para grandes empresas","Parcelamento apenas no cart√£o"], correctIndex:1}
  ];

  /***** Estado local *****/
  let roomCode = null;
  let playerId = null;
  let playerName = null;
  const QUESTION_DURATION = 20; // segundos fixos

  // Elementos
  const btnJoin = document.getElementById('btnJoin');
  const btnStart = document.getElementById('btnStart');
  const roomInput = document.getElementById('roomInput');
  const nameInput = document.getElementById('nameInput');
  const joinedInfo = document.getElementById('joinedInfo');
  const playersList = document.getElementById('playersList');
  const statusArea = document.getElementById('statusArea');
  const questionArea = document.getElementById('questionArea');
  const qIndex = document.getElementById('qIndex');
  const qText = document.getElementById('qText');
  const optionsWrap = document.getElementById('optionsWrap');
  const timerBar = document.getElementById('timerBar');
  const timeLeft = document.getElementById('timeLeft');
  const summaryArea = document.getElementById('summaryArea');
  const endArea = document.getElementById('endArea');
  const finalRanking = document.getElementById('finalRanking');
  const btnRestartLocal = document.getElementById('btnRestartLocal');

  // Helpers
  function uid(){ return Math.random().toString(36).slice(2,9); }
  function now(){ return Date.now(); }

  // Database refs
  function roomRef(code){ return db.ref('rooms/'+code); }
  function playersRef(code){ return db.ref('rooms/'+code+'/players'); }
  function answersRef(code, index){ return db.ref('rooms/'+code+'/answers/'+index); }
  function summariesRef(code, index){ return db.ref('rooms/'+code+'/summaries/'+index); }

  // Join
  btnJoin.onclick = async ()=>{
    const code = (roomInput.value||'').trim();
    const name = (nameInput.value||'').trim();
    if(!code || !name){ alert('Digite c√≥digo da sala e seu nome.'); return; }
    roomCode = code;
    playerName = name;
    playerId = uid();
    // create player record
    await playersRef(roomCode).child(playerId).set({ id:playerId, name:playerName, score:0, joinedAt: now() });
    joinedInfo.innerHTML = `Voc√™ entrou como <b>${playerName}</b> na sala <b>${roomCode}</b>.`;
    btnStart.disabled = false;
    observeRoom(roomCode);
    observePlayers(roomCode);
  };

  // Start (anyone)
  btnStart.onclick = async ()=>{
    if(!roomCode) return alert('Entre na sala primeiro.');
    const r = roomRef(roomCode);
    // Initialize room record (only if not exists)
    await r.update({
      status: 'lobby',
      currentIndex: null,
      startedBy: playerId,
      startedAt: null,
      duration: QUESTION_DURATION
    });
    // start game immediately: set first question
    startGameAsStarter();
    btnStart.disabled = true;
  };

  // Starter: schedules progression
  async function startGameAsStarter(){
    const r = roomRef(roomCode);
    // set currentIndex=0 and startedAt
    await r.update({ currentIndex: 0, status: 'question', startedAt: now(), duration: QUESTION_DURATION });
    // schedule timer loop
    scheduleNextTick();
  }

  // schedule loop executed by starter: wait duration and aggregate
  function scheduleNextTick(){
    // Only the starter schedules. We'll set an onDisconnect marker to allow detection (not implemented advanced failover)
    (async ()=>{
      while(true){
        const snap = await roomRef(roomCode).once('value');
        const room = snap.val();
        if(!room) return;
        if(room.status === 'ended'){ return; }
        if(room.status !== 'question') return; // only progress when question
        const idx = room.currentIndex;
        const startedAt = room.startedAt || now();
        const durMs = (room.duration||QUESTION_DURATION) * 1000;
        const endAt = startedAt + durMs;
        const wait = Math.max(0, endAt - now());
        // wait
        await new Promise(res => setTimeout(res, wait + 50)); // plus small buffer
        // After end, aggregate answers and create summary
        try {
          await aggregateAnswersAndAdvance(roomCode, idx);
        } catch(e){ console.error('Erro ao agregar/avan√ßar', e); }
        // after aggregateAnswersAndAdvance executes, loop will continue if status set to next question
      }
    })();
  }

  // Aggregation: read answers for index, compute points, write summary and update players
  async function aggregateAnswersAndAdvance(code, index){
    const rRef = roomRef(code);
    const rSnap = await rRef.once('value'); const room = rSnap.val();
    if(!room) return;
    // To avoid race: only proceed if room.currentIndex == index and status == 'question'
    if(room.currentIndex !== index || room.status !== 'question') return;
    const ansSnap = await answersRef(code, index).once('value');
    const answers = ansSnap.val() || {};
    // Build summary list
    const summaryList = [];
    // For each player in room, check answer
    const playersSnap = await playersRef(code).once('value');
    const players = playersSnap.val() || {};
    // compute points: base fixed 1000 (we can adjust), bonus proportional to remaining time (but since we aggregate after end, we approximate: earlier responders get small advantage by submittedAt)
    const basePoints = 1000;
    // Convert answers object {playerId: {choice, ts}}
    // We'll sort by answeredAt ascending to assign small extra bonus for speed (optional)
    const arrAnswers = Object.keys(answers).map(pid=>({ pid, choice: answers[pid].choice, ts: answers[pid].ts || 0 }));
    arrAnswers.sort((a,b)=> (a.ts||0) - (b.ts||0));
    // assign
    for(const a of arrAnswers){
      const p = players[a.pid] ? players[a.pid].name : ('Jogador');
      const choiceIndex = a.choice;
      const q = QUESTIONS[index];
      const correct = (choiceIndex === q.correctIndex);
      // speed bonus: earlier responder gets small bonus up to 500
      const rank = arrAnswers.findIndex(x=>x.pid===a.pid);
      const speedBonus = Math.max(0, 500 - (rank * 40)); // example
      const points = correct ? (basePoints + speedBonus) : 0;
      summaryList.push({ pid: a.pid, name: p, choiceIndex, choiceText: q.options[choiceIndex], correct, points });
    }
    // Also include players who didn't answer
    Object.keys(players).forEach(pid=>{
      if(!answers[pid]){
        summaryList.push({ pid, name: players[pid].name, choiceIndex: null, choiceText: '-', correct: false, points: 0 });
      }
    });
    // Write summary to DB
    await summariesRef(code, index).set({ createdAt: now(), list: summaryList });
    // Update each player's score (increment)
    const updates = {};
    summaryList.forEach(s=>{
      if(s.points && s.points>0){
        updates['players/'+s.pid+'/score'] = (players[s.pid] && players[s.pid].score ? players[s.pid].score + s.points : s.points);
      }
    });
    // apply updates atomically
    await rRef.update({ status: 'summary' });
    if(Object.keys(updates).length) await db.ref('rooms/'+code).update(updates);
    // small pause to let clients see the summary (3s)
    await new Promise(res => setTimeout(res, 3000));
    // advance to next or end
    const nextIndex = index + 1;
    if(nextIndex >= QUESTIONS.length){
      await rRef.update({ status: 'ended', currentIndex: nextIndex, endedAt: now() });
    } else {
      await rRef.update({ status: 'question', currentIndex: nextIndex, startedAt: now() });
    }
  }

  // Observe room changes and update UI (clients)
  function observeRoom(code){
    roomRef(code).on('value', snap=>{
      const room = snap.val();
      if(!room){ statusArea.innerText = 'Sala criada, aguardando jogadores...'; return; }
      if(room.status === 'lobby'){ statusArea.innerText = 'Sala em lobby. Clique Iniciar para come√ßar.'; }
      if(room.status === 'question'){
        // show question
        const idx = room.currentIndex;
        const q = QUESTIONS[idx];
        showQuestion(idx, q, room.startedAt, room.duration || QUESTION_DURATION);
      } else if(room.status === 'summary'){
        // show summary for currentIndex
        const idx = room.currentIndex;
        showSummary(code, idx);
      } else if(room.status === 'ended'){
        showEnd(code);
      }
    });
  }

  // Observe players list
  function observePlayers(code){
    playersRef(code).on('value', snap=>{
      const players = snap.val() || {};
      renderPlayers(players);
    });
  }

  function renderPlayers(players){
    playersList.innerHTML = '';
    Object.keys(players).forEach(pid=>{
      const p = players[pid];
      const d = document.createElement('div'); d.className='lc';
      d.innerHTML = `<div>${p.name}</div><div class="small">${p.score||0} pts</div>`;
      playersList.appendChild(d);
    });
  }

  // Show question (client-side)
  let localAnswered = false;
  function showQuestion(index, q, startedAt, duration){
    endArea.classList.add('hidden');
    questionArea.classList.remove('hidden');
    summaryArea.innerHTML = '';
    qIndex.innerText = `Pergunta ${index+1}/${QUESTIONS.length}`;
    qText.innerText = q.question;
    optionsWrap.innerHTML = '';
    localAnswered = false;
    // create options
    q.options.forEach((opt, i)=>{
      const d = document.createElement('div'); d.className='option'; d.innerText = opt;
      d.onclick = async ()=>{
        if(localAnswered) return;
        localAnswered = true;
        d.classList.add('disabled');
        // write answer to DB: /rooms/{room}/answers/{index}/{playerId} = {choice:i, ts:now()}
        if(!roomCode || !playerId) return alert('Voc√™ deve entrar na sala primeiro.');
        await answersRef(roomCode, index).child(playerId).set({ choice: i, ts: now() });
      };
      optionsWrap.appendChild(d);
    });
    // timer
    const dur = (duration||QUESTION_DURATION) * 1000;
    const start = startedAt || now();
    const endAt = start + dur;
    // update visual timer
    function tick(){
      const leftMs = Math.max(0, endAt - now());
      const pct = Math.max(0, Math.min(100, (leftMs/dur)*100));
      timerBar.style.width = pct + '%';
      timeLeft.innerText = Math.ceil(leftMs/1000);
      if(leftMs>0) requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);
  }

  // Show summary: reads /rooms/{code}/summaries/{index}
  async function showSummary(code, index){
    summaryArea.innerHTML = '<div class="small">Carregando resumo...</div>';
    const sSnap = await summariesRef(code, index).once('value');
    const summary = sSnap.val();
    if(!summary || !summary.list){ summaryArea.innerHTML = '<div class="small">Nenhuma resposta registrada.</div>'; return; }
    const list = summary.list;
    summaryArea.innerHTML = '';
    // show each answer
    list.forEach(it=>{
      const div = document.createElement('div'); div.className='lc';
      const left = document.createElement('div'); left.innerHTML = `<b>${it.name}</b>`;
      const right = document.createElement('div'); right.innerHTML = `${ it.choiceIndex===null ? '-' : it.choiceText } ${ it.correct ? '‚úÖ' : '‚ùå' }`;
      div.appendChild(left); div.appendChild(right);
      summaryArea.appendChild(div);
    });
  }

  // Show end ranking
  async function showEnd(code){
    questionArea.classList.add('hidden');
    endArea.classList.remove('hidden');
    finalRanking.innerHTML = '';
    const pSnap = await playersRef(code).orderByChild('score').once('value');
    const obj = pSnap.val() || {};
    // convert to array and sort desc
    const arr = Object.keys(obj).map(k=>({ id:k, name: obj[k].name, score: obj[k].score || 0 }));
    arr.sort((a,b)=> b.score - a.score);
    arr.forEach((p,i)=>{
      const d = document.createElement('div'); d.className='lc';
      d.innerHTML = `<div style="font-weight:700">${i+1}. ${p.name}</div><div class="small">${p.score} pts</div>`;
      finalRanking.appendChild(d);
    });
  }

  // restart local (only resets answers+scores in DB for this room) - careful: used for tests
  btnRestartLocal.onclick = async ()=>{
    if(!roomCode) return alert('Entre numa sala antes.');
    if(!confirm('Reiniciar esta sala (apaga respostas e zera pontua√ß√µes)?')) return;
    const r = roomRef(roomCode);
    // remove answers and summaries and reset players scores
    await db.ref('rooms/'+roomCode+'/answers').remove();
    await db.ref('rooms/'+roomCode+'/summaries').remove();
    const pSnap = await playersRef(roomCode).once('value');
    const players = pSnap.val() || {};
    const updates = {};
    Object.keys(players).forEach(pid=> updates['players/'+pid+'/score'] = 0 );
    updates['status'] = 'lobby';
    updates['currentIndex'] = null;
    updates['startedAt'] = null;
    await db.ref('rooms/'+roomCode).update(updates);
    alert('Sala reiniciada (respostas e pontua√ß√µes zeradas).');
  };

  // If player leaves (tab closed), optionally remove from players list ‚Äî optional: we'll try to remove on unload
  window.addEventListener('beforeunload', ()=>{
    if(roomCode && playerId){
      // best-effort removal (not guaranteed)
      playersRef(roomCode).child(playerId).remove();
    }
  });

  // Small helper: auto-fill a room name to test quickly
  roomInput.value = 'SOUFACIL_TEST';
  </script>
</body>
</html>
